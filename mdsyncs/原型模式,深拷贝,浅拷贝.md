---
title: "åŸå‹æ¨¡å¼,æ·±æ‹·è´,æµ…æ‹·è´"
date: 2020-07-14T11:54:29+08:00
draft: true
tags: ["è®¾è®¡æ¨¡å¼","iOS"]
---

### åŸå‹æ¨¡å¼



æœ¬æ–‡æ¦‚å¿µä¸»è¦æ‘˜å–ä¹¦ç±**[ã€Šå¤§è¯è®¾è®¡æ¨¡å¼ã€‹](https://book.douban.com/subject/6424904/)**, ObjCçš„æ·±æµ…æ‹·è´ä¸»è¦æ˜¯å¯¹**[ã€Šè‹¹æœå¼€å‘æ–‡æ¡£ ã€‹](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Collections/Articles/Copying.html#//apple_ref/doc/uid/TP40010162-SW3)**ç›¸å…³å†…å®¹çš„ç†è§£å’Œç¿»è¯‘ï¼Œä»¥åŠå†™ä»£ç è¿›è¡ŒéªŒè¯.  æ–‡ç« ä¸­å¦‚æœ‰é”™è¯¯ï¼Œè¯·ä»¥åŸä¹¦ä»¥åŠå®˜æ–¹æ–‡æ¡£ä¸ºå‡†ã€‚



> åŸå‹æ¨¡å¼ (Prototype):ç”¨åŸå‹å¯¹è±¡å®ä¾‹åˆ¶å®šåˆ›å»ºå¯¹è±¡çš„ç§ç±»ï¼Œå¹¶ä¸”é€šè¿‡æ‹·è´è¿™äº›åŸå‹åˆ›å»ºæ–°çš„å¯¹è±¡.
>
> ![image-20200717144712499](/Users/liuxiaoyong/Library/Application Support/typora-user-images/image-20200717144712499.png)

> åŸå‹æ¨¡å¼å…¶å®å°±æ˜¯ä»ä¸€ä¸ªå¯¹è±¡å†åˆ›å»ºå¦å¤–ä¸€ä¸ªå¯å®šåˆ¶çš„å¯¹è±¡, è€Œä¸”ä¸éœ€è¦çŸ¥é“ä»»ä½•åˆ›å»ºçš„ç»†èŠ‚.

ä»£ç å¦‚ä¸‹ : 

```java
class Person implements Cloneable {
    int age;
    String name;

    Location location;
		
    @Override
    protected Object clone() throws CloneNotSupportedException {
        return super.clone();
    }
}

class Location {
    String city;
    int no;

    public Location(String city, int no) {
        this.city = city;
        this.no = no;
    }
}

public class Test {

    public static void main(String[] args) throws Exception{

        Person p1 = new Person(8, "Jack", new Location("åŒ—äº¬", 110));
        Person p2 = (Person) p1.clone();

        p2.age = 10;
        p2.name = "Rose";
        p2.location.city = "çŸ³å®¶åº„";
        p2.location.no = 310;
        System.out.println(p1);	// Person{age=8, name='Jack', location=Location{city='çŸ³å®¶åº„', no=310}}
        System.out.println(p2); // Person{age=10, name='Rose', location=Location{city='çŸ³å®¶åº„', no=310}}
        System.out.println(p1 == p2); // false
        System.out.println(p1.location == p2.location); // true
    }
}
```

- Personç±», å®ç° **Cloneable**åè®®, å¹¶ä¸”å®ç° **clone()** æ–¹æ³•
- å°±å®ç°äº†ä¸€ä¸ªç®€å•çš„**åŸå‹**(clone)æ¨¡å¼
- ä½†æ˜¯æŸ¥çœ‹è¾“å‡ºåï¼Œå‘ç°ä¿®æ”¹ **p2.location**ä¹‹å, **p1.location**ä¹Ÿè¢«æ”¹å˜ï¼Œp2 å’Œ p1ä¸¤ä¸ªå¯¹è±¡äº’ç›¸å½±å“äº†.
- ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ å°±æ¶‰åŠåˆ°äº†**æ·±å¤åˆ¶ï¼Œæµ…å¤åˆ¶**çš„æ¦‚å¿µ.



### æ·±å¤åˆ¶ã€æµ…å¤åˆ¶

- Person ç±»ä¸­çš„ int age, String name éƒ½æ˜¯**å€¼å¼•ç”¨**, è€Œ Location location æ˜¯**åœ°å€å¼•ç”¨**
- super.clone()æ–¹æ³•æ˜¯è¿™æ ·
  - å¦‚æœå­—æ®µæ˜¯**å€¼ç±»å‹**ï¼Œåˆ™å¯¹è¯¥å­—æ®µæ‰§è¡Œé€ä½å¤åˆ¶.
  - å¦‚æœå­—æ®µæ˜¯**åœ°å€ç±»å‹**, åˆ™**å¤åˆ¶å¼•ç”¨**ä½†**ä¸å¤åˆ¶å¼•ç”¨çš„å¯¹è±¡**.
- å› æ­¤, p1 å’Œ p2çš„locationæŒ‡å‘çš„æ˜¯åŒæ„å¯¹è±¡
- **æµ…å¤åˆ¶** : **è¢«å¤åˆ¶çš„å¯¹è±¡çš„æ‰€æœ‰å˜é‡éƒ½å«æœ‰ä¸åŸæ¥å¯¹è±¡ç›¸åŒçš„å€¼, è€Œæ‰€æœ‰çš„å¯¹å…¶ä»–å¯¹è±¡çš„å¼•ç”¨éƒ½ä»ç„¶æŒ‡å‘åŸæ¥çš„å¯¹è±¡.**
- **æ·±å¤åˆ¶** : **å¯¹å…¶ä»–å¯¹è±¡çš„å¼•ç”¨å˜é‡ä¹Ÿå¤åˆ¶æˆæ–°çš„å¯¹è±¡ï¼Œè€Œä¸æ˜¯å¼•ç”¨åŸæœ‰çš„å¯¹è±¡.**
- å¦‚ä½•å®ç° **location** çš„**æ·±å¤åˆ¶** ï¼Ÿ
  - Locationç±» ä¹Ÿå®ç° **Cloneable** æ¥å£ï¼Œå¹¶å®ç° **clone()** æ–¹æ³•
  - ä¸”åœ¨ Personç±»çš„ **clone()**æ–¹æ³•ä¸­, **clone**ä¸€ä»½ location å¯¹è±¡ï¼Œå¹¶å°†cloneåçš„å¯¹è±¡å¤åˆ¶ç»™æ–°çš„person
- ä»£ç å¦‚ä¸‹ : 

```java
class Person implements Cloneable {
    int age = 8;
    int score = 100;

    Location location;
    protected Object clone() throws CloneNotSupportedException {
        Person person = (Person)super.clone();
        person.location = (Location)location.clone();
        return person;
    }
}

class Location implements Cloneable {
    String city;
    int no;
		
    @Override
    protected Object clone() throws CloneNotSupportedException {
        return super.clone();
    }
}
```



æ·±å¤åˆ¶åï¼Œè¿è¡Œä¸Šé¢åŒæ ·çš„æµ‹è¯•ä»£ç ï¼Œè¾“å‡ºç»“æœå°±ä¸åŒäº†ã€‚

> Person{age=8, name=Jack, location=Location{city='åŒ—äº¬', no=110}}
> Person{age=10, name=Rose, location=Location{city='çŸ³å®¶åº„', no=310}}
> false
> false

- å¯ä»¥çœ‹å‡º, ä¿®æ”¹p2çš„ location ä¹‹åï¼Œæ²¡æœ‰å½±å“ p1ã€‚ ä¸” p1.location == p2.location è¾“å‡º falseã€‚
- è¯´æ˜ p1 å’Œ p2çš„location æ²¡æœ‰æŒ‡å‘ç›¸åŒå¯¹è±¡, å®ç°äº† locationå¯¹è±¡çš„æ·±å¤åˆ¶
- å½“å¯¹è±¡ä¸­ï¼Œåˆæœ‰å­å¯¹è±¡ï¼Œå­å¯¹è±¡åˆæœ‰å¯¹è±¡å±æ€§æ—¶å‘¢ï¼Ÿ
  - è¿™ç§æƒ…å†µï¼Œä½¿ç”¨æ—¶è¦è€ƒè™‘å¥½æ·±å¤åˆ¶è¦å¤åˆ¶å¤šå°‘å±‚ï¼Œè€Œä¸”è¦å½“å¿ƒå‡ºç°å¾ªç¯å¼•ç”¨ã€‚



#### Apple Developer Documentation

> # Copying Collections
>
> There are two kinds of object copying: shallow copies and deep copies. The normal copy is a shallow copy that produces a new collection that shares ownership of the objects with the original. Deep copies create new objects from the originals and add those to the new collection. This difference is illustrated by Figure 1.
>
> - å¯¹è±¡å¤åˆ¶æœ‰ä¸¤ç§ç±»å‹ : æµ…å¤åˆ¶å’Œæ·±å¤åˆ¶.
> - æ™®é€šçš„å¤åˆ¶æ˜¯æµ…å¤åˆ¶ï¼Œå®ƒä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„é›†åˆï¼Œæ–°é›†åˆå’ŒåŸé›†åˆå…±åŒäº«æœ‰å¯¹è±¡çš„æ‰€æœ‰æƒã€‚
> - æ·±å¤åˆ¶ä»åŸé›†åˆä¸­æ‹·è´æ‰€æœ‰å¯¹è±¡ï¼Œå¹¶æ–°å¯¹è±¡å…¶æ·»åŠ åˆ°æ–°é›†åˆä¸­ã€‚
>
> Figure1 å±•ç¤ºäº† æµ…æ‹·è´ å’Œ æ·±æ‹·è´çš„åŒºåˆ«.
>
> **Figure 1** Shallow copies and deep copies![img](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Collections/Art/CopyingCollections_2x.png)
>
> 
>
> ## Shallow Copies
>
> There are a number of ways to make a shallow copy of a collection. When you create a shallow copy, the objects in the original collection are sent a `retain` message and the pointers are copied to the new collection. Listing 1 shows some of the ways to create a new collection using a shallow copy.
>
> - æœ‰å¾ˆå¤šæ–¹æ³•å¯ä»¥å¯¹é›†åˆè¿›è¡Œæµ…å¤åˆ¶ã€‚ å½“ä½ åˆ›å»ºä¸€ä¸ªæµ…å¤åˆ¶å¯¹è±¡æ—¶ã€‚åŸé›†åˆä¸­çš„å¯¹è±¡ä¼šè¢«å‘é€ä¸€ä¸ª retain æ¶ˆæ¯, å¹¶ä¸”æŒ‡é’ˆå°†è¢«å¤åˆ¶åˆ°æ–°é›†åˆä¸­.
>
> Listing 1å±•ç¤ºäº†ä¸€äº›æµ…å¤åˆ¶çš„æ–¹æ³•.
>
> **Listing 1** Making a shallow copy
>
> | `NSArray *shallowCopyArray = [someArray copyWithZone:nil];`  |
> | :----------------------------------------------------------- |
> | ` `                                                          |
> | `NSDictionary *shallowCopyDict = [[NSDictionary alloc] initWithDictionary:someDictionary copyItems:NO];` |
>
> ```objc
> Cat *cat = [[Cat alloc] initWithName:@"ğŸ±"];
> Person *obj = [[Person alloc] initWithName:@"Jack" gender:@"male" cat:cat];
> NSArray *arr1 = @[obj];
> NSArray *arr2 = [arr1 copyWithZone:nil];
> ```
>
> ```objc
> Cat *cat = [[Cat alloc] initWithName:@"ğŸ±"];
> Person *obj = [[Person alloc] initWithName:@"Jack" gender:@"male" cat:cat];
> NSArray *arr1 = @[obj];
> NSArray *arr2 = [[NSArray alloc] initWithArray:arr1 copyItems:NO];
> ```
>
> éªŒè¯è¿™ä¸¤ç§æƒ…å†µ,  éƒ½æ˜¯æµ…æ‹·è´, ä¸¤ä¸ªæ•°ç»„ä¸­ Personå¯¹è±¡çš„å†…å­˜ä¸€æ ·.
>
> ![å±å¹•å¿«ç…§ 2020-07-17 ä¸‹åˆ5.36.17](https://tva1.sinaimg.cn/large/007S8ZIlly1ggu3ur44m4j309w056mxr.jpg)
>
> 
>
> These techniques are not restricted to the collections shown. For example, you can copy a set with the `copyWithZone:` methodâ€”or the `mutableCopyWithZone:` methodâ€”or an array with `initWithArray:copyItems:` method.
>
> - è¿™äº›æŠ€æœ¯ä¸ä»…é™äºæ‰€ç¤ºçš„é›†åˆã€‚ä¾‹å¦‚ï¼Œä½ å¯ä»¥ä½¿ç”¨ copyWithZone `mutableCopyWithZoneæ‹·è´é›†åˆ
> - ä¹Ÿå¯ä»¥ä½¿ç”¨ initWithArray:copyItems å¤åˆ¶æ•°ç»„.
>
> 
>
> ## Deep Copies
>
> There are two ways to make deep copies of a collection. You can use the collectionâ€™s equivalent of `initWithArray:copyItems:` with `YES` as the second parameter. If you create a deep copy of a collection in this way, each object in the collection is sent a `copyWithZone:` message. If the objects in the collection have adopted the `NSCopying` protocol, the objects are deeply copied to the new collection, which is then the sole owner of the copied objects. If the objects do not adopt the `NSCopying`protocol, attempting to copy them in such a way results in a runtime error. However, `copyWithZone:` produces a shallow copy. This kind of copy is only capable of producing a one-level-deep copy. If you only need a one-level-deep copy, you can explicitly call for one as in Listing 2.
>
> - æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥æ·±æ‹·è´é›†åˆ. ä½ å¯ä»¥ä½¿ç”¨é›†åˆçš„ç­‰æ•ˆé¡¹ initWithArray:copyItems: å¹¶ä»¥ YESä½œä¸º ç¬¬äºŒä¸ªå‚æ•°
> - å¦‚æœä½ ç”¨è¿™ç§æ–¹å¼åˆ›å»ºé›†åˆçš„æ·±æ‹·è´å‰¯æœ¬, åˆ™é›†åˆä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ä¼šæ”¶åˆ° copyWithZone: æ¶ˆæ¯ã€‚
> - å¦‚æœé›†åˆä¸­çš„å¯¹è±¡å·²å®ç° **NSCopying** åè®®ï¼Œåˆ™å°†å¯¹è±¡æ·±å¤åˆ¶åˆ°é›†åˆä¸­ï¼Œæ–°é›†åˆæ˜¯è¢«å¤åˆ¶å¯¹è±¡çš„å”¯ä¸€æ‰€æœ‰è€…ã€‚
> - å¦‚æœé›†åˆä¸­çš„å¯¹è±¡æ²¡æœ‰å®ç° **NSCopying**åè®®, åˆ™ä»¥è¿™ç§æ–¹å¼å¤åˆ¶ä¼šå¯¼è‡´**è¿è¡Œæ—¶é”™è¯¯**.
> - ç„¶è€Œ, **copyWithZone** ä¹Ÿä¼šäº§ç”Ÿ**æµ…æ‹·è´**. è¿™ç§æ‹·è´æ–¹å¼å€¼èƒ½ç”Ÿæˆ **ä¸€çº§æ·±æ‹·è´**å‰¯æœ¬ã€‚ å¦‚æœä½ åªéœ€è¦ä¸€ä¸ª**ä¸€çº§æ·±æ‹·è´**å‰¯æœ¬,  ä½ å¯ä»¥æ˜¾ç¤ºçš„è°ƒç”¨æ¸…å•2æ‰€ç¤ºçš„æ–¹æ³•.
>
> **Listing 2** Making a deep copy
>
> ```
> NSArray *deepCopyArray=[[NSArray alloc] initWithArray:someArray copyItems:YES];
> ```
>
> ```objc
> Cat *cat = [[Cat alloc] initWithName:@"ğŸ±"];
> Person *obj = [[Person alloc] initWithName:@"Jack" gender:@"male" cat:cat];
> NSArray *arr1 = @[obj];
> NSArray *arr2 = [[NSArray alloc] initWithArray:arr1 copyItems:YES];
> ```
>
> ![å±å¹•å¿«ç…§ 2020-07-17 ä¸‹åˆ5.39.48](https://tva1.sinaimg.cn/large/007S8ZIlly1ggu3xytpx4j30a005ggm9.jpg)
>
> æ‰§è¡Œç»“æœå¦‚ä¸Šå›¾ : 
>
> - ä¸¤ä¸ªæ•°ç»„ä¸­ peson å¯¹è±¡åœ°å€ä¸ä¸€æ ·
> - è€Œä¸¤ä¸ªperson å¯¹è±¡çš„ cat å†…å­˜åœ°å€ä¸€æ ·
> - æ‰€ä»¥ç»“è®ºæ˜¯ : äº§ç”Ÿäº†**æ·±æ‹·è´**ï¼Œ ä¸”æ˜¯ **ä¸€çº§æ·±æ‹·è´**ï¼Œ ç¬¬äºŒçº§åˆ«æ²¡æœ‰ä»ç„¶æ˜¯æµ…æ‹·è´
>
> 
>
> This technique applies to the other collections as well. Use the collectionâ€™s equivalent of `initWithArray:copyItems:` with `YES` as the second parameter.
>
> - è¿™é¡¹æŠ€æœ¯ä¹Ÿé€‚ç”¨äºå…¶ä»–é›†åˆï¼Œä½¿ç”¨é›†åˆçš„ç­‰æ•ˆé¡¹ initWithArray:copyItems: å¹¶ä»¥ YES ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°.
>
> If you need a true deep copy, such as when you have an array of arrays, you can archive and then unarchive the collection, provided the contents all conform to the `NSCoding` protocol. An example of this technique is shown in Listing 3.
>
> - å¦‚æœä½ éœ€è¦ä¸€ä¸ªçœŸæ­£çš„**æ·±å¤åˆ¶**å‰¯æœ¬(å‡å¦‚ï¼Œå½“ä½ æœ‰ä¸€ä¸ªäºŒç»´æ•°ç»„æ—¶).
>
> - ä½ å¯ä»¥é€šè¿‡å½’æ¡£å†æ¥æ¡£è¯¥é›†åˆ. å¦‚æœå…¶ä¸­å¯¹è±¡å…¨éƒ¨éƒ½å®ç° **NSCoding**åè®®.
>
> - Listing3 å±•ç¤ºäº†æ­¤æŠ€æœ¯çš„ä¸€ä¸ªç¤ºä¾‹.
>
>   
>
> **Listing 3** A true deep copy
>
> | `NSArray* trueDeepCopyArray = [NSKeyedUnarchiver unarchiveObjectWithData:` |
> | ------------------------------------------------------------ |
> | `          [NSKeyedArchiver archivedDataWithRootObject:oldArray]];` |
>
> 
>
> ## Copying and Mutability
>
> When you copy a collection, the mutability of that collection or the objects it contains can be affected. Each method of copying has slightly different effects on the mutability of the objects in a collection of arbitrary depth:
>
> - `copyWithZone:` makes the surface level immutable. All deeper levels have the mutability they previously had.
> - `initWithArray:copyItems:` with `NO` as the second parameter gives the surface level the mutability of the class it is allocated as. All deeper levels have the mutability they previously had.
> - `initWithArray:copyItems:` with `YES` as the second parameter gives the surface level the mutability of the class it is allocated as. The next level is immutable, and all deeper levels have the mutability they previously had.
> - Archiving and unarchiving the collection leaves the mutability of all levels as it was before.
>
> 
>
> - å½“å¤åˆ¶é›†åˆæ—¶ï¼Œ è¯¥é›†åˆæˆ–å…¶åŒ…å«å¯¹è±¡çš„å¯å˜æ€§å¯èƒ½ä¼šæ”¶åˆ°å½±å“.
>
> - æ¯ç§å¤åˆ¶æ–¹æ³•å¯¹ä»»æ„æ·±åº¦çš„é›†åˆä¸­å¯¹è±¡çš„å¯å˜æ€§ç•¥æœ‰ä¸åŒ.
>
>   - **copyWithZone** : ä½¿è¡¨å±‚ä¸å˜ï¼Œ æ·±å±‚æ¬¡çš„å¯¹è±¡ç»´æŒå…¶ä¹‹å‰çš„å¯å˜æ€§
>
>   - **initWithArray:copyItems:** å½“ç¬¬äºŒä¸ªå‚æ•°ä¸º NO æ—¶, ä½¿è¡¨å±‚å…·æœ‰å…¶ç±»çš„å¯å˜æ€§ã€‚æ‰€æœ‰æ›´æ·±å±‚æ¬¡çš„å…ƒç´ éƒ½å…·æœ‰ä»¥å‰çš„å¯å˜æ€§
>
>     - ä»£ç ç¤ºä¾‹ : 
>     - arr2 çš„å¯å˜æ€§æœ‰ [NSArray alloc] çš„ç±»å‹ç¡®å®š, å¦‚æœç”¨ NSArray åˆå§‹åŒ–, åˆ™ arr2ä¸å¯å˜
>     - ä½¿ç”¨ NSMutableArray åˆå§‹åŒ–, åˆ™ arr2 å¯å˜
>
>     ```objc
>     NSArray *arr1 = @[@"1",@"2",@"3"];
>     NSMutableArray *arr2 = [[NSArray alloc] initWithArray:arr1 copyItems:NO];
>     ```
>
>   - **initWithArray:copyItems:** å½“ç¬¬äºŒä¸ªå‚æ•°ä½ YESæ—¶ï¼Œ ä½¿è¡¨å±‚å…·æœ‰å…¶ç±»çš„å¯å˜æ€§ã€‚ ä¸‹ä¸€çº§åˆ«æ˜¯ä¸å¯å˜çš„ï¼Œå¹¶ä¸”æ‰€æœ‰æ›´æ·±å±‚æ¬¡çš„å…ƒç´ éƒ½å…·æœ‰å…¶ä»¥å‰çš„å¯å˜æ€§
>
> - **å½’æ¡£ / æ¥æ¡£** å°†ä¿ç•™æ‰€æœ‰çº§åˆ«å…ƒç´ çš„å¯å˜æ€§ã€‚



### éå®¹å™¨ç±»å¯¹è±¡

#### NSStringçš„æ‹·è´

- è‡ªå®šä¹‰å¯¹è±¡çš„ **copyWithZone**: æ–¹æ³•ï¼Œæ˜¯æˆ‘ä»¬è‡ªå·±å®ç°ï¼Œæˆ‘ä»¬æ¸…æ¥šå…¶æ˜¯**æ·±æ‹·è´**è¿˜æ˜¯**æµ…æ‹·è´**
- ä½†æ˜¯ **NSString** çš„ copy æ˜¯æ·±æ‹·è´è¿˜æ˜¯æµ…æ‹·è´å‘¢ ? 
- ä¸èƒ½çœ‹æºä»£ç ï¼Œåªèƒ½ä»£ç éªŒè¯å’¯

##### éªŒè¯

- **ä¸å¯å˜**å­—ç¬¦ä¸²ï¼Œ**copy** 	**-> æµ…æ‹·è´**

```objc
NSString *str1 = @"I am a String";
NSString *str2 = str1.copy;

NSLog(@"%@,<memory address: %p>", str1, str1);
NSLog(@"%@,<memory address: %p>", str1, str2);
```

```objc
æµ‹è¯•[60501:1063290] I am a String,<memory address: 0x1000020a8>
æµ‹è¯•[60501:1063290] I am a String,<memory address: 0x1000020a8>
```

- **å¯å˜**å­—ç¬¦ä¸², **copy**	-> **æ·±æ‹·è´**

```objc
NSMutableString *str1 = [NSMutableString stringWithString:@"I am a String"];
NSString *str2 = str1.copy;

NSLog(@"%@,<memory address: %p>", str1, str1);
NSLog(@"%@,<memory address: %p>", str1, str2);
```

```objc
æµ‹è¯•[60516:1064232] I am a String,<memory address: 0x100608d40>
æµ‹è¯•[60516:1064232] I am a String,<memory address: 0x100608e00>
```

- **ä¸å¯å˜**å­—ç¬¦ä¸², **mutableCopy** -> **æ·±æ‹·è´**

```objc
NSString *str1 = @"I am a String";
NSString *str2 = str1.mutableCopy;

NSLog(@"%@,<memory address: %p>", str1, str1);
NSLog(@"%@,<memory address: %p>", str1, str2);
```

```objc
æµ‹è¯•[60527:1065196] I am a String,<memory address: 0x1000020a8>
æµ‹è¯•[60527:1065196] I am a String,<memory address: 0x101852a10>
```

- **å¯å˜**å­—ç¬¦ä¸², **mutableCopy** -> **æ·±æ‹·è´**

```objc
NSMutableString *str1 = [NSMutableString stringWithString:@"I am a String"];
NSString *str2 = str1.mutableCopy;

NSLog(@"%@,<memory address: %p>", str1, str1);
NSLog(@"%@,<memory address: %p>", str1, str2);
```

```objc
æµ‹è¯•[60539:1066040] I am a String,<memory address: 0x100554890>
æµ‹è¯•[60539:1066040] I am a String,<memory address: 0x100554950>
```



##### ç»“è®º

é€šè¿‡ä»¥ä¸Šä»£ç åˆ†æï¼Œå¯ä»¥å¾—å‡ºç»“è®º : 

- **[immutableObj copy]  -> æµ…å¤åˆ¶**
- **[immutableObj mutableCopy]  -> æ·±å¤åˆ¶**
- **[mutableObj copy]  -> æ·±å¤åˆ¶**
- **[mutableObj copy]  -> æ·±å¤åˆ¶**



### è‡ªå®šä¹‰å¯¹è±¡çš„æ‹·è´

- åœ¨ObjCä¸­ï¼Œä½¿ç”¨åŸå‹æ¨¡å¼åˆ›å»ºè‡ªå®šä¹‰å¯¹è±¡, æ¯”å¦‚ Personç±»

  - é¦–å…ˆéœ€è¦éµå®ˆ **NSCopying**åè®®

    ```objc
    @interface Person : NSObject <NSCopying>
    ```

  - å®ç° **copyWithZone:** æ–¹æ³•

    ```objc
    - (id)copyWithZone:(nullable NSZone *)zone{
        Person *copyObj = [[[self class] allocWithZone:zone] initWithName:_name gender:_gender];
        return copyObj;
    }
    ```

  - è¿™æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ **copy** æ¥åˆ›å»º Person å¯¹è±¡äº†

    ```objc
    int main(int argc, const char * argv[]) {
        @autoreleasepool {
            Person *p1 = [[Person alloc] initWithName:@"Jack" gender:@"male"];
            Person *p2 = p1.copy;
            
            p2.name = @"Rose";
            p2.gender = @"female";
            
            NSLog(@"%@",p1);
            NSLog(@"%@",p2);
        }
        return 0;
    }
    ```

  - æˆ‘ä»¬è¦†å†™äº† **description** æ–¹æ³•ï¼Œæœ€ç»ˆæ‰“å°ç»“æœå¦‚ä¸‹ : 

    ```objc
    - (NSString *)description{
        return [NSString stringWithFormat:@"%@ is %@, <memory address: %p>", _name, _gender, self];
    }
    ```

    ```
    æµ‹è¯•[60329:1050217] Jack is male, <memory address: 0x10059d840>
    æµ‹è¯•[60329:1050217] Rose is female, <memory address: 0x10059e010>
    ```

  - å¯ä»¥çœ‹åˆ°, æ‰“å°å‡ºçš„å†…å­˜åœ°å€ä¸åŒï¼Œæˆ‘ä»¬æŠŠè¿™ç§**copy**ç§°ä¸º**æ·±æ‹·è´** (**deep copy**), ä¹Ÿç§°ä¸º**å€¼æ‹·è´**

    - æˆ‘ä»¬ä¿®æ”¹ p2 ä¸ä¼šå¯¹ p1 é€ æˆå½±å“ï¼Œ å› ä¸ºæ ˆä¸­p1 p2ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘å †ä¸­ä¸¤ä¸ªä¸åŒçš„åœ°å€

    ![<u>å±å¹•å¿«ç…§ 2020-07-16 ä¸‹åˆ5.32.03</u>](https://tva1.sinaimg.cn/large/007S8ZIlly1ggu47zd8ccj311s0e2q87.jpg)

  - æ·±æ‹·è´çš„åŸå› ï¼Œæ˜¯æˆ‘ä»¬åœ¨ copyWithZone æ–¹æ³•ä¸­ï¼Œé‡æ–° alloc äº†å†…å­˜ç©ºé—´ , é‚£å‡å¦‚æˆ‘ä»¬ä¸é‡æ–°ç”³è¯·å†…å­˜ç©ºé—´å‘¢?

  - é‡å†™copyWithZone æ–¹æ³•å¦‚ä¸‹ : 

    - æ²¡æœ‰é‡æ–°ç”³è¯·å†…å­˜ç©ºé—´

    ```objc
    - (id)copyWithZone:(nullable NSZone *)zone{
        Person *copyObj = [self initWithName:_name gender:_gender];
        return copyObj;
    }
    ```

    - mainå‡½æ•°ä¸­ä»£ç ä¸æ”¹åŠ¨ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹:

    ```
    æµ‹è¯•[60355:1053881] Rose is female, <memory address: 0x100612520>
    æµ‹è¯•[60355:1053881] Rose is female, <memory address: 0x100612520>
    ```

    - å‘ç° å¯¹ p2çš„ä¿®æ”¹ï¼Œå½±å“äº† p1ï¼Œ å¹¶ä¸” p1 å’Œ p2çš„å†…å­˜åœ°å€æ˜¯ä¸€æ ·çš„ã€‚

  - è¿™ç§copy,æˆ‘ä»¬ç§°ä¸º **æµ…æ‹·è´(Shadow Copy)**, ä¹Ÿå«**æŒ‡é’ˆæ‹·è´**

  - æ²¡æœ‰ä¸º p2 ç”³è¯·æ–°çš„å †ç©ºé—´, è€Œæ˜¯å°† p2æŒ‡é’ˆæ‰§è¡Œ p1 æŒ‡å‘çš„åœ°å€ ã€‚

  - p2çš„ä¿®æ”¹ï¼Œä¿®æ”¹äº†å †ç©ºé—´çš„å€¼ï¼Œå¯¹p1äº§ç”Ÿå½±å“



å‚è€ƒæ–‡çŒ®

[å¤§è¯æ•°æ®ç»“æ„](https://book.douban.com/subject/6424904/)

[è‹¹æœå¼€å‘æ–‡æ¡£](https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/Collections/Articles/Copying.html#//apple_ref/doc/uid/TP40010162-SW3)