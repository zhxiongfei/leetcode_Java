---
title: "å‡½æ•°æŒ‡é’ˆ,blockä¸lambdaè¡¨è¾¾å¼"
date: 2020-07-07T00:56:36+08:00
draft: true
tags: ["iOS"]
category: "iOS"
---

**Cè¯­è¨€**ä¸­çš„**å‡½æ•°æŒ‡é’ˆ**, **OjbC**ä¸­çš„**block**,ä»¥åŠ**C++**å’Œ**Java**ä¸­çš„**lambdaè¡¨è¾¾å¼**éå¸¸ç±»ä¼¼.

åœ¨å­¦ä¹ å•ä¸ªè¯­è¨€æ—¶ä¸ä¼šæƒ³åˆ°ä»–ä»¬ä¹‹é—´çš„å…±é€šç‚¹å’ŒåŒºåˆ«ï¼Œæœ€è¿‘åœ¨å­¦ä¹ C++ å’Œ Javaè¯­æ³•æ—¶ï¼Œå‘è§‰**lambdaè¡¨è¾¾å¼**ï¼Œè¿™ä¸æ˜¯è·ŸObjCä¸­çš„ block éå¸¸ç›¸ä¼¼å—ï¼Ÿ

è¯´åˆ°åº•ä¸éƒ½æ˜¯ï¼Œå¯ä»¥**æ•è·å˜é‡**çš„**æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ**å—?

æ‰€ä»¥æ‰“ç®—å†™ä¸€ç¯‡æ€»ç»“å„è¯­è¨€ä¸­**å‡½æ•°æŒ‡é’ˆ**çš„ä½¿ç”¨çš„æ–‡ç« ã€‚

å› ä¸ºç¬”è€…æ˜¯iOSå¼€å‘äººå‘˜ï¼Œæ‰€ä»¥å¯¹ ObjCçš„blockä¼šä»‹ç»çš„è¯¦ç»†ä¸€äº›ã€‚ Cå‡½æ•°æŒ‡é’ˆ å’Œ C++ lambdaè¡¨è¾¾å¼ç®€å•è¿‡ä¸€ä¸‹ã€‚

## ä¸€, Cå‡½æ•°æŒ‡é’ˆ

### æ¦‚å¿µ

- åœ¨å­¦ä¹  Cè¯­è¨€æ—¶ï¼Œæˆ‘ä»¬å­¦åˆ°äº†**å‡½æ•°æŒ‡é’ˆ**ï¼Œå…¶å®šä¹‰å°±æ˜¯æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆã€‚
- é€šå¸¸**æŒ‡é’ˆ**æ˜¯æŒ‡å‘ä¸€ä¸ª**å˜é‡**ï¼Œè€Œ**å‡½æ•°æŒ‡é’ˆ**æ˜¯æŒ‡å‘å‡½æ•°ã€‚
- å‡½æ•°æŒ‡é’ˆä¹Ÿå¯ä»¥åƒå‡½æ•°ä¸€æ ·ï¼Œ**è°ƒç”¨**å‡½æ•°ï¼Œ**ä¼ é€’å‚æ•°**ã€‚



### ä»£ç ä¸¾ä¾‹ 

ä»¥ä¸‹ä»£ç æ˜¯ä¸€ä¸ªç®€å•çš„**å‡½æ•°æŒ‡é’ˆ**çš„ç”¨æ³•

```c
// å‡½æ•°
int sum(int a, int b){
    return a + b;
}
int main(int argc, const char * argv[]) {
    @autoreleasepool {       
        // å®šä¹‰ä¹‹æˆ˜ ptr æŒ‡å‘ sumå‡½æ•°
        int (*ptr)(int, int) = sum;
        // é€šè¿‡ å‡½æ•°æŒ‡é’ˆ ptr è°ƒç”¨ sumå‡½æ•°
        int res = ptr(10, 20);
        printf("%d\n", res);
    }
    return 0;
}
```



## äºŒ, C++ lambdaè¡¨è¾¾å¼

### æ¦‚å¿µ

- **C++**ä¸­çš„ **lambdaè¡¨è¾¾å¼** ç±»ä¼¼ ObjCä¸­çš„blockï¼Œå…¶æœ¬è´¨ä¸Šå°±æ˜¯**å‡½æ•°**.
- å®Œæ•´ç»“æ„ : **[capture list][paramas list\]  mutable exception -> return type{function body}**
  - **capture list** ï¼šæ•è·å¤–éƒ¨å˜é‡åˆ—è¡¨
  - **params list** : å½¢å‚åˆ—è¡¨ï¼Œä¸èƒ½ä½¿ç”¨é»˜è®¤å‚æ•°, ä¸èƒ½çœç•¥å‚æ•°å
  - **mutable** : ç”¨æ¥è¯´æ˜æ˜¯å¦å¯ä»¥ä¿®æ”¹æ•è·çš„å˜é‡
  - **exception** : å¼‚å¸¸è®¾å®š
  - **return type** : è¿”å›å€¼ç±»å‹
  - **function body** : å‡½æ•°ä½“
- æœ‰æ—¶å¯ä»¥çœç•¥éƒ¨åˆ†ç»“æ„ : 
  - **[capture list]\(params list) -> return type{function body}**
  - **[capture list]\(params list) {function body}**
  - **[capture list]\{function body}**

### ä»£ç ä¸¾ä¾‹ 

```cpp
int main(int argc, const char * argv[]) {
    // å®šä¹‰ lambdaè¡¨è¾¾å¼
    int (*ptr1)(int, int) = [](int a, int b) -> int{
        return a + b;
    };
    cout << ptr1(10, 20) << endl;
    return 0;
}
```

- è€Œåœ¨ C++11ä»¥åï¼Œå¼•å…¥äº†**è‡ªåŠ¨ç±»å‹æ¨æ–­**
- æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœç•¥ä¸Šè¾¹å¤æ‚çš„ç±»å‹å®šä¹‰ï¼Œ ç›´æ¥å†™ **auto**
- è‡ªåŠ¨ç±»å‹æ¨æ–­æ˜¯ç¼–è¯‘å™¨æ¥è¯†åˆ«æ¨æ–­ç±»å‹
- åœ¨ç¼–è¯‘åå½¢æˆçš„æ±‡ç¼–ä»£ç ä¸­ï¼Œå’Œä¸»åŠ¨å†™çš„ç±»å‹æ²¡æœ‰ä»»ä½•åŒºåˆ«
- ä¸ä¼šå½±å“ç¨‹åºæŒ‡å‘æ•ˆç‡

```cpp
int main(int argc, const char * argv[]) {
    // å®šä¹‰ lambdaè¡¨è¾¾å¼
    int (*ptr1)(int, int) = [](int a, int b) -> int{
        return a + b;
    };
    cout << ptr1(10, 20) << endl;
    return 0;
    
    // å®šä¹‰ lambdaè¡¨è¾¾å¼
    // C++11 åŠ å…¥è‡ªåŠ¨ç±»å‹æ¨æ–­
    // æ‰€ä»¥æˆ‘ä»¬å¯ä»¥çœç•¥ä¸Šè¾¹å¤æ‚çš„ ç±»å‹ï¼Œç›´æ¥å†™auto
    // è‡ªåŠ¨ç±»å‹æ¨æ–­æ˜¯ç¼–è¯‘å™¨æ¥è¯†åˆ«æ¨æ–­ã€‚
    // åœ¨ç¼–è¯‘åå½¢æˆçš„ä»£ç è·Ÿåˆ¶å®šç±»å‹æ²¡æœ‰åŒºåˆ«
    // ä¸ä¼šå½±å“ç¨‹åºè¿è¡Œæ•ˆç‡
    auto ptr2 = [](int a, int b) -> int{
        return a + b;
    };
    cout << ptr2(10, 20) << endl;
}
```



### æœ¬è´¨

lambdaè¡¨è¾¾å¼åœ¨ç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨ä¼šå°†**lambdaè¡¨è¾¾å¼ç”Ÿæˆå‡½æ•°**ï¼Œ æ‰€ä»¥ lambdaè¡¨è¾¾å¼çš„æœ¬è´¨å…¶å®å°±æ˜¯**å‡½æ•°**, è€Œlambdaè¡¨è¾¾å¼çš„è°ƒç”¨ï¼Œå…¶å®å°±æ˜¯**å‡½æ•°è°ƒç”¨**ã€‚

æˆ‘ä»¬ç”¨æ±‡ç¼–ä»£ç æ¥è¯æ˜è¿™ä¸ªé—®é¢˜ã€‚

- ä¸Šè¿°ä»£ç åœ¨è¿è¡Œæ—¶è½¬ä¸ºæ±‡ç¼–ä»¥åï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€å¼ å›¾ä¸­ï¼Œæ˜¯å°† main.cpp æ–‡ä»¶çš„ç¬¬14è¡Œè½¬ä¸ºäº†ä¸€ä¸‹çš„æ±‡ç¼–ï¼Œè€Œç¬¬14è¡Œæ­£æ˜¯lambdaè¡¨è¾¾å¼ã€‚
- æˆ‘ä»¬ä¸€æ­¥æ­¥è·Ÿè¿›å»æ±‡ç¼–ä»£ç ï¼Œåˆ°äº†ç¬¬äºŒå¼ å›¾å‡½æ•°çš„å®ç°ï¼Œå¯ä»¥çœ‹åˆ° ç¡®å®æ˜¯**åŠ æ³•**æ“ä½œ
  - ä¸€æ­¥æ­¥çš„ä½¿ç”¨å¯„å­˜å™¨èµ‹å€¼ï¼Œèµ‹å€¼åè¿›è¡ŒåŠ æ³•æ“ä½œï¼Œå†å°†ç»“æœè¿”å›

![æˆªå±2020-07-05ä¸‹åˆ10.17.00](https://tva1.sinaimg.cn/large/007S8ZIlly1ggggje2tcvj31ce0fyaen.jpg)

![æˆªå±2020-07-05ä¸‹åˆ10.17.56](https://tva1.sinaimg.cn/large/007S8ZIlly1ggggjjgmaaj31fw07cwgu.jpg)



### ä½œä¸ºå‚æ•°

- å‡è®¾æˆ‘ä»¬æœ‰ åŠ å‡ä¹˜é™¤ å››ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯ä¼ å…¥ä¸¤ä¸ªæ•°å­—ï¼Œè¿›è¡ŒåŠ å‡ä¹˜é™¤æ“ä½œ
- è¿˜æœ‰ä¸ª execæ–¹æ³•ï¼Œç”¨æ¥ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œå¹¶ä¼ å…¥å‡½æ•°åï¼Œè¿›è¡Œå¯¹åº”çš„åŠ å‡ä¹˜é™¤æ“ä½œ

#### ä¸ä½¿ç”¨ lambdaè¡¨è¾¾å¼

ä»£ç å¦‚ä¸‹ : 

```cpp
int add(int v1, int v2){
    return v1 + v2;
}

int subtrace(int v1, int v2){
    return v1 - v2;
}

int multiply(int v1, int v2){
    return v1 * v2;
}

int divide(int v1, int v2){
    return v1 / v2;
}

int exec(int v1, int v2, int(*func)(int, int)){
    return func(v1, v2);
}

int main(int argc, const char * argv[]) {

    cout << exec(20, 10, add) << endl;
    cout << exec(20, 10, subtrace) << endl;
    cout << exec(20, 10, multiply) << endl;
    cout << exec(20, 10, divide) << endl;
    
    return 0;
}
```



#### ä½¿ç”¨ lambdaè¡¨è¾¾å¼

ä»£ç å¦‚ä¸‹ : 

```cpp
int main(int argc, const char * argv[]) {

    cout << exec(20, 10, [](int a, int b){ return a + b; }) << endl;
    cout << exec(20, 10, [](int a, int b){ return a - b; }) << endl;
    cout << exec(20, 10, [](int a, int b){ return a * b; }) << endl;
    cout << exec(20, 10, [](int a, int b){ return a / b; }) << endl;
    
    return 0;
}
```

- ä¸Šè¿°ä»£ç æ‰§è¡Œå’Œä¸ä½¿ç”¨ ç¬¬ä¸€ç§å†™æ³• æ•ˆæœä¸€æ ·
- ä»¥ä¸Šå°±æ˜¯ä½œä¸ºå‚æ•°ä½¿ç”¨çš„ä¾‹å­



### å˜é‡æ•è·capture

#### æ¦‚å¿µ

- ä¸­æ‹¬å· [] é‡Œè¾¹æ”¾çš„æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿè²Œä¼¼æˆ‘ä»¬ä¸Šè¾¹ä¸€åªæ²¡æœ‰ç”¨åˆ°
- []é‡Œæ”¾å…¥çš„æ˜¯ç”¨æ¥åšå˜é‡æ•è·çš„ã€‚ 
- æˆ‘ä»¬åœ¨ **labmdaè¡¨è¾¾å¼**ä¸­ä½¿ç”¨**å¤–éƒ¨å±€éƒ¨å˜é‡**æ—¶ï¼Œé»˜è®¤æ˜¯ä¸å¯ä»¥è®¿é—®çš„
- éœ€è¦å°†å˜é‡åæ·»åŠ åˆ° [] ä¸­ï¼Œ æ‰å¯ä»¥è®¿é—®ã€‚



#### ä¸¾ä¾‹è¯´æ˜

![æˆªå±2020-07-05ä¸‹åˆ10.51.02](https://tva1.sinaimg.cn/large/007S8ZIlly1ggghhvxdxrj31fy0a475w.jpg)

- æˆ‘ä»¬åœ¨ func ä¸­ï¼Œè®¿é—®å±€éƒ¨å˜é‡ a , æ˜¯ä¸å¯ä»¥ç›´æ¥è®¿é—®çš„ã€‚
- å¦‚æœéœ€è¦è®¿é—®ï¼Œéœ€è¦å°†å˜é‡åæ”¾åˆ° [] ä¸­ï¼Œä»£ç å¦‚ä¸‹

```cpp
int main(int argc, const char * argv[]) {

    int a = 10;
    int b = 20;
    auto func = [a, b]{
        cout << a << endl;
        cout << b << endl;
    };
    func();
    return 0;
}
```

- ä¸Šè¿°ä»£ç ä¸­ï¼Œ æˆ‘ä»¬å¯ä»¥ç›´æ¥è®¿é—®å˜é‡a å’Œ å˜é‡ b



#### å€¼æ•è·ï¼Ÿåœ°å€æ•è·ï¼Ÿ

```cpp
int main(int argc, const char * argv[]) {

    int a = 10;
    int b = 20;
    auto func = [a, b]{
        cout << a << endl;
        cout << b << endl;
    };
  	
  	a = 30;
  	b = 40;
  
    func();
    return 0;
}
```

- æˆ‘ä»¬å¯ä»¥è®¿é—® a, bå˜é‡ä»¥åï¼Œå¦‚æœæˆ‘ä»¬åç»­å°† aï¼Œ bçš„å€¼æ”¹äº†ï¼Œå†è°ƒç”¨ func() æ—¶ï¼Œè®¿é—®åˆ°çš„æ˜¯10ï¼Œ20è¿˜æ˜¯ 30ï¼Œ40å‘¢ï¼Ÿ
  - ç­”æ¡ˆæ˜¯10, 20
- why ?  çœ‹èµ·æ¥ï¼Œæˆ‘æ˜æ˜å°†ç”¨åˆ°çš„ a å’Œ b çš„å€¼æ”¹æ‰äº†ï¼Œä¸ºä»€ä¹ˆè®¿é—®è¿˜æ˜¯åŸæ¥çš„å€¼å‘¢ï¼Ÿ
  - å› ä¸ºè¿™é‡Œçš„å˜é‡æ•è·æ˜¯**å€¼æ•è·** ï¼Œä¹Ÿå°±æ˜¯è¯´funcç›´æ¥å°† 10ï¼Œ20 æ•è·äº†ï¼Œåè¾¹ä¿®æ”¹ aï¼Œbçš„å€¼è·Ÿfuncå†…éƒ¨æ•è·çš„å€¼å®Œå…¨æ²¡æœ‰å…³ç³»ã€‚
- å¦‚ä½•å®ç°ï¼Œåœ¨ aï¼Œbä¿®æ”¹ä»¥åï¼Œè°ƒç”¨ func() æ—¶ï¼Œè®¿é—®æ–°çš„ aï¼Œbçš„å€¼å‘¢ï¼Ÿ
  - ç­”æ¡ˆæ˜¯ **åœ°å€æ•è·**ï¼Œå¦‚ä½•åŠåˆ°åœ°å€æ•è·å‘¢ï¼Ÿ (ç±»ä¼¼åœ¨ç”¨çš„éå¸¸å¤šçš„ **swap()**å‡½æ•°ä¸­çš„**åœ°å€å¼•ç”¨**)
    - å¾ˆç®€å•ï¼Œæˆ‘ä»¬åœ¨ [] ä¸­æ•è·å˜é‡æ—¶ï¼Œç›´æ¥å¯¹aå–åœ°å€ï¼Œä¼ è¿›å»ï¼Œä¹Ÿå°±æ˜¯å°†&aæ”¾å¤§ [] ä¸­
    - åœ°å€æ•è·ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥
      - åœ¨ func() å‡½æ•°è°ƒç”¨æ—¶ï¼Œæ ¹æ® a çš„åœ°å€ï¼Œæ‰¾åˆ° a æœ€æ–°çš„å€¼
      - å¹¶ä¸”ï¼Œå¯ä»¥æ ¹æ® a çš„åœ°å€ç»™ a èµ‹å€¼



### mutable

- åœ¨ä¸Šè¾¹å°æ®µçš„å­¦ä¹ ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“å€¼æ•è·æ—¶ä¸å¯ä»¥ä¿®æ”¹å¼•ç”¨çš„å˜é‡çš„å€¼çš„ï¼Œå› ä¸ºæˆ‘ä»¬ç›¸å½“äºå•å•å¼•ç”¨äº†å€¼ï¼Œä¹Ÿå°±æ˜¯å¸¸é‡
- è¿˜æœ‰å¦å¤–ä¸€ç§åšæ³•ï¼Œæ¥å®ç° åœ¨ func å†…éƒ¨ä¿®æ”¹ a çš„å€¼
  - ä½¿ç”¨ mutable å…³é”®å­—
- é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼Œ ä½¿ç”¨ mutableå…³é”®å­—åï¼Œ å˜é‡ä»ç„¶æ˜¯ **å€¼æ•è·**
- æ‰€ä»¥ï¼Œåœ¨ func å†…éƒ¨ä¸å¯èƒ½ä¿®æ”¹å¤–éƒ¨ a çš„å€¼
- ä½†æ˜¯å¯ä»¥ä¿®æ”¹ func() å†…éƒ¨å˜é‡ a çš„å€¼
- **mutable**å…³é”®å­—åšæ³•ç±»ä¼¼äº
  - åœ¨ func() å‡½æ•°ä½“å†…éƒ¨ï¼Œåˆå§‹åŒ–äº†ä¸€ä¸ªå˜é‡ï¼Œåˆå§‹å€¼ä¸º a
  - æ‰€ä»¥åœ¨ func()å‡½æ•°é¢˜å†…éƒ¨ï¼Œå½“ç„¶å¯ä»¥ä¿®æ”¹ å…¶å†…éƒ¨çš„ a
  - ä½†æ˜¯æ— æ³•å¯¹å¤–éƒ¨çš„ a äº§ç”Ÿå½±å“ã€‚

```java
int main(int argc, const char * argv[]) {
    int a = 10;
    auto func = [a]() mutable{
        a = 20;
        cout << "func -> " << a << endl;
    };
    func();
    cout << a << endl;
    return 0;
}
```

- æ‰€ä»¥ä¸Šè¿°ä»£ç çš„æ‰“å°ç»“æœä¸º
  - **func -> 20**
  - **10***
  - **Program ended with exit code: 0**
- å…¶å†…éƒ¨çš„aè¢«ä¿®æ”¹äº†ï¼Œä½†æ˜¯å¤–éƒ¨çš„å€¼ä»ç„¶æ˜¯åŸæ¥çš„å€¼ã€‚



## ä¸‰,ObjC block

### ä»C++çœ‹blockæœ¬è´¨

- é¦–å…ˆæ¥çœ‹ä¸€ä¸ªæœ€ç®€å•çš„block, æ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡æœ‰å‚æ•°

  ```objc
  int a = 10;
  void (^block)(void) = ^{
     NSLog(@"a is %d", a);
  };
  block();
  ```

- æˆ‘ä»¬ç¼–å†™çš„ OCä»£ç ï¼Œåº•å±‚å®ç°å…¶å®éƒ½æ˜¯ C/C++ä»£ç 

- æ‰€ä»¥è¦ç†è§£ block çš„æœ¬è´¨ï¼Œ æˆ‘ä»¬å°†ä¸‹è¾¹ä»£ç è½¬æ¢ä¸º C++ ä»£ç 

  ```
  xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main.cpp
  ```

- è½¬ä¸ºC++ä»£ç ä»¥å, æˆ‘ä»¬åˆ›å»ºå’Œè°ƒç”¨ block ä»£ç å¦‚ä¸‹ : 

  ```cpp
  // blockçš„èµ‹å€¼ 
  void (*block)(void) = &__main_block_impl_0(__main_block_func_0, &__main_block_desc_0_DATA, a));
  // blockçš„è°ƒç”¨
  block->FuncPtr();
  ```

  ```cpp
  // blockç»“æ„ä½“
  struct __main_block_impl_0 {
    struct __block_impl impl;					// å®ç°
    struct __main_block_desc_0* Desc; // æè¿°
    int a;														// æ•è·çš„å˜é‡
  };
  ```

  ```cpp
  // block çš„å®ç°ç»“æ„ä½“
  struct __block_impl {
    void *isa;
    int Flags;
    int Reserved;
    void *FuncPtr;	// FuncPtræŒ‡å‘å‡½æ•°çš„å…·ä½“å®ç°
  };
  ```

  ```java
  // block çš„æè¿°ä¿¡æ¯
  static struct __main_block_desc_0 {
    size_t reserved;
    size_t Block_size;
  }
  ```

  ```cpp
  // __block_impl çš„ funcPtræŒ‡å‘çš„å‡½æ•°å…·ä½“å®ç°
  // å°±æ˜¯ï¼Œæˆ‘ä»¬ç¼–å†™çš„ ObjC çš„ æ‰“å° "a is %d", a
  static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
    	int a = __cself->a; // bound by copy
  		NSLog(***, a);
  }
  ```

- ç»è¿‡è½¬ä¸º C++ ä»£ç ï¼Œåˆ†æåå‘ç°ï¼Œæˆ‘ä»¬åœ¨ ObjC ä¸­ç¼–å†™çš„ block ä»£ç ï¼Œåœ¨ C++ä¸­è½¬ä¸ºäº†**ç»“æ„ä½“**

- è¿™ä¸ªç»“æ„ä½“ä¸­ï¼ŒåŒ…å« block å‡½æ•°çš„å…·ä½“å®ç°ï¼Œblock çš„sizeç­‰ç­‰

- å¹¶ä¸”åœ¨ blockç»“æ„ä½“ä¸­ï¼Œæœ‰æˆ‘ä»¬è®¿é—®çš„**å¤–éƒ¨å±€éƒ¨å˜é‡ int a**



### block çš„å˜é‡æ•è· capture

#### ä¸¾ä¾‹åˆ†æ

- ä¸Šè¾¹çš„åˆ†æä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥ block è®¿é—®çš„å¤–éƒ¨å±€éƒ¨å˜é‡ï¼Œè¢«**æ•è·**åˆ°äº†blockç»“æ„ä½“å†…éƒ¨

- ä¸ºä»€ä¹ˆè¦æ•è·è¿™ä¸ªå˜é‡å‘¢ï¼Ÿ 

- ä¸¾ä¸ªğŸŒ°ï¼ŒæŸ¥çœ‹ä¸‹è¾¹ä»£ç  : 

  ```objc
  int main(int argc, const char * argv[]) {
      @autoreleasepool {
          void (^block)(void) = nil;
          {
              int a = 10;
              block = ^{
                  NSLog(@"a is %d", a);
              };
          }
          block();
      }
      return 0;
  }
  ```

- int a æ˜¯å±€éƒ¨å˜é‡, åœ¨èŠ±æ‹¬å·ç»“æŸåï¼Œ aå°±é‡Šæ”¾äº†

- æ—¢ç„¶å®ƒé‡Šæ”¾äº†ï¼Œæˆ‘ä»¬åœ¨èŠ±æ‹¬å·å¤–è°ƒç”¨block() å¦‚ä½•è®¿é—® a å‘¢

- è¿™å°±ç”¨åˆ°äº†**å˜é‡æ•è·**, è¦**ä¿è¯æˆ‘ä»¬åœ¨ block å‡½æ•°ä½“ä¸­èƒ½è®¿é—®éœ€è¦çš„å±€éƒ¨å˜é‡ï¼Œæ‰€ä»¥éœ€è¦å˜é‡æ•è·ã€‚**



#### C++åˆ†æ

- ä»ä¸Šè¿° C++ ä»£ç å¯ä»¥çœ‹å‡ºï¼Œåœ¨æ„å»º block çš„ ç»“æ„ä½“æ—¶ï¼Œå°† å˜é‡ a ä¼ å…¥äº† ç»“æ„ä½“çš„**æ„é€ å‡½æ•°**ï¼Œ ä½¿ç”¨**C++ä¸­åˆå§‹åŒ–åˆ—è¡¨**ç»™ç»“æ„ä½“ä¸­çš„ a èµ‹å€¼

- åœ¨**__main_block_func_0** ä¸­ï¼Œè®¿é—® a æ—¶ã€‚ ç›´æ¥å–å‡ºæ¥ **int a = __cself->a;** ,å†è¿›è¡Œè®¿é—®

  

#### å€¼å¼•ç”¨ï¼Ÿåœ°å€å¼•ç”¨ï¼Ÿ

##### å€¼å¼•ç”¨

å…ˆçœ‹å¦‚ä¸‹ä»£ç ã€‚

```c
 int a = 10;
 void (^block)(void)  = ^{
     NSLog(@"a is %d", a);
 };
 a = 20;
 block();
```

- é—®é¢˜ï¼š åœ¨ block ä¸­ è¾“å‡ºçš„ a æ˜¯10 è¿˜æ˜¯ 20 ï¼Ÿ
- ç­”æ¡ˆæ˜¯ **10**
- ä¸ºä»€ä¹ˆæ˜¯10å‘¢ï¼Ÿ ä»ä¸Šè¿° C++ ä»£ç åˆ†æå¯ä»¥çœ‹å‡ºæ¥ï¼Œ æˆ‘ä»¬æ˜¯ç›´æ¥æ‹¿ a çš„å€¼ç›´æ¥ä¼ å…¥æ„é€ å‡½æ•°ï¼Œä¸ºç»“æ„ä½“ä¸­ a èµ‹å€¼
- æ‰€ä»¥è¿™é‡Œæ˜¯**å€¼å¼•ç”¨**ï¼Œ ç›¸å½“äºè¿™é‡Œç›´æ¥æŠŠ 10 æ•è·åˆ°ç»“æ„ä½“ä¸­ï¼Œ å†ä¸ å˜é‡ a æ²¡æœ‰ä¸€ç‚¹å…³ç³»ã€‚
- è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆï¼Œåœ¨blockä¸­ä¸èƒ½ç»™ a èµ‹å€¼çš„åŸå› ï¼Œblockä¸­èƒ½è®¿é—®çš„ a ç›¸å½“äºæ˜¯å¸¸é‡ 10



##### åœ°å€å¼•ç”¨

é‚£ä¹ˆï¼Œå¦‚ä½•èƒ½å®ç°, å¤–éƒ¨ a å˜åŒ–ä»¥åï¼Œblockå†…éƒ¨çš„ a ä¹Ÿå‘ç”Ÿå˜åŒ–ï¼Ÿä»¥åŠï¼Œå¦‚ä½•æ‰èƒ½åœ¨ block ä¸­ä¿®æ”¹ a çš„å€¼ï¼Ÿ

- ç­”æ¡ˆå°±æ˜¯ä½¿ç”¨ï¼Œ**å¼•ç”¨ä¼ é€’**
- é€šè¿‡å‰è¾¹ C++çš„å­¦ä¹ ï¼ŒC++çš„lambdaè¡¨è¾¾å¼éå¸¸æ–¹ä¾¿æ”¹ä¸ºå¼•ç”¨ä¼ é€’ï¼Œç›´æ¥åœ¨æ•è·åˆ—è¡¨ä¸­ æŠŠ a å˜ä¸º &a å³å¯
- è€Œåœ¨ ObjCä¸­ä¸å¯ä»¥æ˜¾å¼çš„è®¾ç½®æ•è·åˆ—è¡¨ã€‚OCä¸ºæˆ‘ä»¬æä¾›äº† **__block** å…³é”®å­—
  - ä½¿ç”¨ __block ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥åœ¨ blockå‡½æ•°ä½“å†…éƒ¨èµ‹å€¼ï¼Œå¹¶ä¸”å¤–éƒ¨ä¿®æ”¹åï¼Œä¹Ÿå¯ä»¥å€¼åŒæ­¥
- æˆ‘ä»¬çŒœæƒ³ï¼Œä½¿ç”¨ __blockä¿®é¥°åçš„å˜é‡ï¼Œä»**å€¼å¼•ç”¨éå†äº†åœ°å€å¼•ç”¨**
- æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡C++ä»£ç æ¥éªŒè¯æˆ‘ä»¬çš„çŒœæƒ³



##### ä»C++ä»£ç éªŒè¯__blockå…³é”®å­—

- åŒæ ·ï¼Œæˆ‘ä»¬æŠŠ main.m è½¬åŒ–ä¸º main.cpp
- è½¬åŒ–ä¸º cppåï¼Œå‘ç°ä»£ç å˜å¾—ç‰¹åˆ«å¤æ‚ï¼Œæˆ‘ä»¬è¿™é‡Œç€é‡çœ‹é‡ç‚¹ä»£ç ï¼Œæ²¡å¿…è¦å»åˆ†ææ™¦æ¶©éš¾æ‡‚çš„å¤§é‡ C++ä»£ç 

```cpp
// blockçš„ç»“æ„ä½“
struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  // å°è£…äº†å˜é‡aåœ°å€çš„ç»“æ„ä½“
  __Block_byref_a_0 *a; // by ref
};
```

```objc
// å˜é‡a åœ¨ __blockä¿®é¥°åï¼Œå˜ä¸ºç»“æ„ä½“ï¼Œå¹¶ä¸”ç»“æ„ä½“ä¸­åœ°å€å¼•ç”¨å˜é‡ a
__Block_byref_a_0 a = {(void*)0,(__Block_byref_a_0 *)&a, 0, sizeof(__Block_byref_a_0), 10};

block = &__main_block_impl_0(__main_block_func_0, &__main_block_desc_0_DATA, (__Block_byref_a_0 *)&a, 570425344));

(a.__forwarding->a) = 20;

block->FuncPtr)();
```

```cpp
struct __Block_byref_a_0 {
  void *__isa;
__Block_byref_a_0 *__forwarding;
 int __flags;
 int __size;
 int a;
};
```

```cpp
static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
  		__Block_byref_a_0 *a = __cself->a; // bound by ref
  		(a->__forwarding->a) = 30;
}
```

- é‡ç‚¹ä»£ç æ˜¯ä»¥ä¸Šä¸‰æ®µä¸»è¦ä»£ç 
- å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨ __blockä¿®é¥°çš„å˜é‡a, åœ¨å®šä¹‰æ—¶ï¼Œå°±è¢«å°è£…æˆäº†ä¸€ä¸ª ç»“æ„ä½“

  - **__Block_byref_a_0**
    - æ­¤ç»“æ„ä½“ä¸­ï¼Œisaåœ°å€æ˜¯ å˜é‡ a çš„åœ°å€
    - æœ‰ä¸€ä¸ªæŒ‡å‘è‡ªå·±çš„ **__forwarding**æŒ‡é’ˆæŒ‡å‘ 
    - è¿˜æœ‰ å˜é‡ a çš„å€¼
- åœ¨ æ„é€  **__main_block_impl_0**  æ—¶ï¼Œä¼ å…¥çš„æ˜¯ **__Block_byref_a_0** çš„åœ°å€å€¼
- å½“ è®¿é—® a  æ—¶ï¼Œç›´æ¥å–åˆ°çš„ __Block_byref_a_0ç»“æ„ä½“ çš„ (a.__forwarding->a) = 20; åœ°å€èµ‹å€¼
- åœ¨å–å€¼æ—¶ï¼Œä»ç„¶æ˜¯ é€šè¿‡  __Block_byref_a_0ç»“æ„ä½“çš„ __forwwardingæŒ‡é’ˆï¼Œå†æ‰¾åˆ° a çš„åœ°å€æ¥ä¿®æ”¹çš„
- æ€»ç»“æ¥è¯´ï¼Œå°±æ˜¯  ç”¨ **__block** ä¿®é¥°åï¼Œå˜é‡çš„**å€¼å¼•ç”¨ å˜ä¸º åœ°å€å¼•ç”¨**
  - æ‰€ä»¥å¯ä»¥é€šè¿‡åœ°å€æ¥è®¿é—®å˜é‡ a çš„æ›´æ”¹åçš„å€¼
  - ä¹Ÿå¯ä»¥é€šè¿‡åœ°å€æ¥ä¿®æ”¹å¤–éƒ¨å˜é‡ a çš„å€¼

- ä»¥ä¸Šæ˜¯å¯¹ **å±€éƒ¨autoå˜é‡çš„æ€»ç»“**
- ä¸‹è¾¹æˆ‘ä»¬çœ‹å¦å¤–ä¸€ç§æƒ…å†µï¼Œ staticå˜é‡

##### staticå˜é‡

```objc
static int a = 10;
void (^block)(void)  = ^{
    NSLog(@"a is %d", a);
};
a = 20;
block();
```

ä»ç„¶ä½¿ç”¨å‘½ä»¤ï¼Œå°†ä»¥ä¸Šä»£ç è½¬åŒ–ä¸º C++ä»£ç ï¼Œå¦‚ä¸‹ : 

```cpp
struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
  int *a;
};

static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
            int *a = __cself->a; // bound by copy
            NSLog(XXX  (*a));
}

int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool;

        static int a = 10;
        // æ³¨æ„è¿™é‡Œæ˜¯ï¼Œåœ°å€å¼•ç”¨
        block = &__main_block_impl_0(__main_block_func_0, &__main_block_desc_0_DATA, &a));
        a = 20;
        (block)->FuncPtr;
    }
    return 0;
}
```

- å¯ä»¥çœ‹å‡ºæ¥ï¼Œstaticå˜é‡ï¼Œåœ¨blockä¸­çš„å¼•ç”¨æ˜¯ **åœ°å€å¼•ç”¨**
- æ‰€ä»¥å¯ä»¥åœ¨blockä¸­ä¿®æ”¹å˜é‡çš„å€¼ã€‚
- ä¸ºä»€ä¹ˆstaticå˜é‡æ˜¯**åœ°å€å¼•ç”¨**å‘¢ï¼Ÿ 
  - çŒœæƒ³æ˜¯å› ä¸ºï¼Œstaticå˜é‡åœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä»½ï¼Œä¸ä¼šè¢«é‡Šæ”¾ï¼Œä¸ä¼šå­˜åœ¨ï¼Œblockä¸­è®¿é—®æ—¶ï¼Œå˜é‡å·²è¢«é‡Šæ”¾çš„é£é™©
  - æ‰€ä»¥å¯ä»¥ç›´æ¥å¼•ç”¨åœ°å€



##### å…¨å±€å˜é‡

- å…¨å±€å˜é‡ä¸ä¼šè¿›è¡Œå˜é‡æ•è·
- åœ¨ block å‡½æ•°ä½“ä¸­ï¼Œå¯ä»¥ç›´æ¥è®¿é—®å…¨å±€å˜é‡

```objc
int a = 10;
int main(int argc, const char * argv[]) {
    @autoreleasepool {
        
        void (^block)(void)  = ^{
            NSLog(@"a is %d", a);
        };
        a = 20;
        block();
    }
    return 0;
}
```

```cpp
int a = 10;

struct __main_block_impl_0 {
  struct __block_impl impl;
  struct __main_block_desc_0* Desc;
};
static void __main_block_func_0(struct __main_block_impl_0 *__cself) {
    NSLog(a);
}

int main(int argc, const char * argv[]) {
    /* @autoreleasepool */ { __AtAutoreleasePool __autoreleasepool;

        block = &__main_block_impl_0(__main_block_func_0, &__main_block_desc_0_DATA));
        a = 20;
        block->FuncPtr;

    }
    return 0;
}
```



##### å˜é‡æ•è·æ€»ç»“ : 

- å±€éƒ¨å˜é‡ä¼šè¢«æ•è·.
  - auto(é»˜è®¤) ç±»å‹çš„å±€éƒ¨å˜é‡æ˜¯å€¼æ•è·
  - static(é™æ€) ç±»å‹çš„å±€éƒ¨å˜é‡æ˜¯åœ°å€æ•è·
- å…¨å±€å˜é‡ä¸ä¼šè¢«æ•è·
  - å…¨å±€å˜é‡åœ¨ block å‡½æ•°ä½“ä¸­ï¼Œå¯ä»¥ç›´æ¥è®¿é—®ï¼Œä¸ä¼šè¢«æ•è·



##### è¿›é˜¶ - å¦ä¸€ç§å˜é‡

- ä¸‹è¾¹ä»£ç ä¸­ï¼Œ Personæ˜¯ä¸€ä¸ª ObjCç±»ï¼Œè¯·é—®åœ¨  test å‡½æ•°ä¸­çš„blockï¼Œæ˜¯å¦ä¼šæ•è· self ?

```objc
void (^block)(void);

- (void)test{
    block = ^{
        NSLog(@"%p", &self);
    };
}

- (instancetype)init{
    self = [super init];
    if (self) {
        [self test];
        block();
    }
    return self;
}
```

- æ ¹æ®ä¸Šè¾¹çš„ç»éªŒï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œå¦‚æœå˜é‡æ˜¯ å±€éƒ¨å˜é‡ï¼Œå°±ä¼šè¢«æ•è·ã€‚
- æ‰€ä»¥ä¸Šè¾¹çš„é—®é¢˜ï¼Œè½¬åŒ–æˆäº†ï¼Œtest å‡½æ•°ä¸­çš„ self æ˜¯å±€éƒ¨å˜é‡è¿˜æ˜¯å…¨å±€å˜é‡ ? 
- æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±æŠŠ Person.mè½¬æ¢æˆ .cppæ–‡ä»¶ï¼Œæ¥çª¥æ¢æ˜¯å¦è¢«æ•è·

è½¬åŒ–ä¸º .cppåï¼Œä¸»è¦ä»£ç å¦‚ä¸‹ : 

```cpp
// block çš„å®šä¹‰
void (*block)(void);

// block ç»“æ„ä½“
struct __Person__test_block_impl_0 {
  struct __block_impl impl;
  struct __Person__test_block_desc_0* Desc;
  Person *self;
};

// blockå®ç°å‡½æ•°
static void __Person__test_block_func_0(struct __Person__test_block_impl_0 *__cself) {
    Person *self = __cself->self; // bound by copy
    NSLog(&self);
}

// testå‡½æ•°çš„å®ç°
static void _I_Person_test(Person * self, SEL _cmd) {
    block = (&__Person__test_block_impl_0(__Person__test_block_func_0, &__Person__test_block_desc_0_DATA, self, 570425344));
}
```

- æ ¹æ®ä¸Šé¢ä»£ç ï¼Œæˆ‘ä»¬å‘ç°ï¼š
- self è¢«æ•è·åˆ° blockç»“æ„ä½“ä¸­äº†
- è€Œä¸”æ˜¯**å€¼æ•è·**ï¼Œè¯´æ˜ self æ˜¯ä¸€ä¸ªå±€éƒ¨å˜é‡ï¼Œè€Œéå…¨å±€å˜é‡
- ä»testå‡½æ•°çš„å®ç° **_I_Person_test**å¯ä»¥çœ‹å‡ºï¼Œ testå‡½æ•°æœ‰ä¸¤ä¸ª**éšå¼å‚æ•°** 
  - self,   è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨ å¯¹è±¡æ–¹æ³•ï¼Œå‡½æ•°ä½“ä¸­ï¼Œç›´æ¥è®¿é—® self çš„åŸå› 
  - _cmdï¼Œ å‡½æ•°å.



### blockçš„ç±»å‹

- block æœ‰ä¸‰ç§ç±»å‹ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ class å’Œ isaæŒ‡é’ˆæŸ¥çœ‹å…·ä½“ç±»å‹ï¼Œæœ€ç»ˆéƒ½ç»§æ‰¿è‡ª NSBlock ç±»å‹ï¼Œè€Œ NSBlock ç»§æ‰¿è‡ª NSObject
  - __NSGlobalBlock__ ï¼ˆ _NSConcreteGlobalBlock ï¼‰
  - __NSStackBlock__ ï¼ˆ _NSConcreteStackBlock ï¼‰
  - __NSMallocBlock__ ï¼ˆ _NSConcreteMallocBlock ï¼‰

![æˆªå±2020-07-07ä¸Šåˆ12.13.02](https://tva1.sinaimg.cn/large/007S8ZIlly1gghphr2viaj30uy0gyq7l.jpg)



- ä¸ºäº†èƒ½æ›´å¥½çš„ç†è§£ï¼Œblockçš„ä¸‰ç§ç±»å‹ï¼Œæˆ‘ä»¬æœ€å¥½å…³é—­ **ARC**ï¼Œ å› ä¸ºARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ä¼šå¸®æˆ‘ä»¬åšå¾ˆå¤šäº‹æƒ…ï¼Œ
  - æ¯”å¦‚åœ¨æŒ‡é’ˆæŒ‡å‘æ—¶ï¼Œä¼šè‡ªåŠ¨æŠŠ block ä» æ ˆåŒºæ‹·è´åˆ°å †åŒºã€‚ 
  - ä¸åˆ©äºæˆ‘ä»¬å­¦ä¹  block çš„ä¸‰ç§ç±»å‹



- GlobalBlock æ˜¯æ²¡æœ‰è®¿é—®å¤–éƒ¨autoå±€éƒ¨å˜é‡çš„block	
  - å­˜æ”¾åœ¨ ç¨‹åºçš„**æ•°æ®åŒºåŸŸ**ï¼Œä¹Ÿå°±æ˜¯ä»£ç åŒº
- StackBlock è®¿é—®äº†å±€éƒ¨å˜é‡çš„block
  - å­˜æ”¾åœ¨ **æ ˆåŒº**
- MallocBlock è®¿é—®äº†å±€éƒ¨å˜é‡çš„blockï¼Œè°ƒç”¨äº†copyï¼Œå°±ä¼šè¢«å¤åˆ¶åˆ°å †åŒºï¼Œæˆä¸º MallocBlock
  - å­˜æ”¾åœ¨ **å †åŒº**

![æˆªå±2020-07-07ä¸Šåˆ12.19.57](https://tva1.sinaimg.cn/large/007S8ZIlly1gghpnhi2m2j30vc0g444j.jpg)



###### GlobalBlock

```objc
void (^block)(void) = ^{
    NSLog(@"GlobalBlock");
};
block();
NSLog(@"%@", [block class]);
```

- åƒè¿™ç§æ²¡æœ‰è®¿é—® autoå˜é‡çš„ blockï¼Œå…¶ç±»å‹ä¸º **GlobalBlock**



###### StackBlock

```objc
int a = 10;
void (^block)(void) = ^{
    NSLog(@"a is %d", a);
};
NSLog(@"%@", [block class]);
block();
```

- åƒè¿™ç§ï¼Œè®¿é—®äº†autoå±€éƒ¨å˜é‡çš„blockï¼Œ å…¶ç±»å‹ä¸º **StackBlock**
- **StackBlock**å­˜æ”¾åœ¨æ ˆåŒºï¼Œè€Œå­˜æ”¾åœ¨æ ˆåŒºçš„æ•°æ®ï¼Œæ˜¯æœ‰ç¼–è¯‘å™¨å†³å®šå…¶ä»€ä¹ˆæ—¶å€™é‡Šæ”¾çš„ï¼Œç¨‹åºå‘˜æ— æ³•æ›´æ”¹
- è¿™æ ·å°±å¾ˆæœ‰å¯èƒ½ï¼Œå½“æˆ‘ä»¬è®¿é—® **StackBlock**æ—¶ï¼Œblockå†…éƒ¨çš„å˜é‡å·²ç»è¢«é‡Šæ”¾ï¼Œæ— æ³•è®¿é—®

```objc
void (^block)(void);

void test(){
    int a = 10;
    block = ^{
        NSLog(@"a is %d", a);
    };
    NSLog(@"%@", [block class]);
}

int main(int argc, const char * argv[]) {
    @autoreleasepool {
        
        test();
        block();
    }
    return 0;
}
```

- æ¯”å¦‚ï¼Œä¸Šè¾¹ä»£ç ï¼Œblockè™½ç„¶å£°æ˜ä¸ºå…¨å±€ï¼Œ ä½†æ˜¯blockæ˜¯åœ¨**æ ˆåŒº**ï¼Œ å…¶å†…éƒ¨éœ€è¦çš„å˜é‡æ¯”å¦‚ a ä¹Ÿåœ¨æ ˆåŒºã€‚

- å½“testå‡½æ•°ï¼ŒèŠ±æ‹¬å·ç»“æŸåï¼Œ æ ˆçš„å†…å­˜ç©ºé—´å·²ç»é”€æ¯

- æ‰€ä»¥æ‰§è¡Œblockæ—¶ï¼Œå‡ºç°æ··ä¹±

  ```shell
  2020-07-07 00:29:21.841482+0800 æµ‹è¯•[12408:4050060] __NSStackBlock__
  2020-07-07 00:29:21.842224+0800 æµ‹è¯•[12408:4050060] a is -272632552
  ```



æ‰€ä»¥ï¼Œå¦‚ä½•é¿å…blockåœ¨æ ˆåŒºï¼Œè®¿é—®å˜é‡å¯èƒ½ä¼šè¢«éšæ—¶é”€æ¯ï¼Œç¨‹åºå‘˜æ— æ³•æ§åˆ¶çš„é—®é¢˜å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ ; å°† **StackBlock** æ‹·è´åˆ° **å †åŒº**ã€‚è€Œå †åŒºçš„å†…å­˜æ˜¯ç¨‹åºå‘˜å¯ä»¥æ§åˆ¶å…¶ç”Ÿå‘½å‘¨æœŸçš„ã€‚



###### MallocBlock

- ä¸Šè¾¹æˆ‘ä»¬æ€»ç»“è¿‡ï¼ŒStackBlockè°ƒç”¨ copy ï¼Œ ä¼šä»**æ ˆåŒº**æ‹·è´åˆ°**å †åŒº**ï¼Œ æˆä¸º**MallocBlock**

  ```objc
  void (^block)(void);
  
  void test(){
      int a = 10;
      block = [^{
          NSLog(@"a is %d", a);
      } copy];
      NSLog(@"%@", [block class]);
      [block release];
  }
  
  int main(int argc, const char * argv[]) {
      @autoreleasepool {
          
          test();
          block();
      }
      return 0;
  }
  ```

  ```shell
  2020-07-07 00:40:36.241385+0800 æµ‹è¯•[12695:4058169] __NSMallocBlock__
  2020-07-07 00:40:36.242059+0800 æµ‹è¯•[12695:4058169] a is 10
  ```

- å¯ä»¥çœ‹åˆ°ï¼Œblockè°ƒç”¨copyä»¥åï¼ŒStackBlockæœç„¶å˜ä¸º MallocBlock,  å¹¶ä¸”å…¶ä¸­å±€éƒ¨å˜é‡å¯ä»¥è®¿é—®ã€‚



- åœ¨ARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®æƒ…å†µè‡ªåŠ¨å°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Šï¼Œæ¯”å¦‚ä»¥ä¸‹æƒ…å†µ
  - blockä½œä¸ºå‡½æ•°è¿”å›å€¼æ—¶
  - å°†blockèµ‹å€¼ç»™__strongæŒ‡é’ˆæ—¶
  - blockä½œä¸ºCocoa APIä¸­æ–¹æ³•åå«æœ‰usingBlockçš„æ–¹æ³•å‚æ•°æ—¶
  - blockä½œä¸ºGCD APIçš„æ–¹æ³•å‚æ•°æ—¶

- MRCä¸‹blockå±æ€§çš„å»ºè®®å†™æ³•
  ```objc
  @property (copy, nonatomic) void (^block)(void);
  ```

- ARCä¸‹blockå±æ€§çš„å»ºè®®å†™æ³•

  ```objc
  - @property (strong, nonatomic) void (^block)(void);
  - @property (copy, nonatomic) void (^block)(void);
  ```

  

### Blockä¸­è®¿é—® å¯¹è±¡ç±»å‹çš„ autoå˜é‡

- å½“blockå†…éƒ¨è®¿é—®äº†å¯¹è±¡ç±»å‹çš„autoå˜é‡æ—¶

  - å¦‚æœblockæ˜¯åœ¨æ ˆä¸Šï¼Œå°†ä¸ä¼šå¯¹autoå˜é‡äº§ç”Ÿå¼ºå¼•ç”¨

  

- å¦‚æœblockè¢«æ‹·è´åˆ°å †ä¸Š

  - ä¼šè°ƒç”¨blockå†…éƒ¨çš„copyå‡½æ•°
  - copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°
  - _Block_object_assignå‡½æ•°ä¼šæ ¹æ®autoå˜é‡çš„ä¿®é¥°ç¬¦ï¼ˆ__strongã€__weakã€__unsafe_unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨

- å¦‚æœblockä»å †ä¸Šç§»é™¤
  - ä¼šè°ƒç”¨blockå†…éƒ¨çš„disposeå‡½æ•°
  - disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°
  - _Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„autoå˜é‡ï¼ˆreleaseï¼‰



### __blockçš„å†…å­˜ç®¡ç†

- å½“blockåœ¨æ ˆä¸Šæ—¶ï¼Œå¹¶ä¸ä¼šå¯¹__blockå˜é‡äº§ç”Ÿå¼ºå¼•ç”¨
- å½“blockè¢«copyåˆ°å †æ—¶
  - ä¼šè°ƒç”¨blockå†…éƒ¨çš„copyå‡½æ•°
  - copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°_
  - Block_object_assignå‡½æ•°ä¼šå¯¹__blockå˜é‡å½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰

- å½“blockä»å †ä¸­ç§»é™¤æ—¶
  - ä¼šè°ƒç”¨blockå†…éƒ¨çš„disposeå‡½æ•°
  - disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°
  - _Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„__blockå˜é‡ï¼ˆreleaseï¼‰



### å¯¹è±¡ç±»å‹çš„autoå˜é‡ã€__blockå˜é‡

- å½“blockåœ¨æ ˆä¸Šæ—¶ï¼Œå¯¹å®ƒä»¬éƒ½ä¸ä¼šäº§ç”Ÿå¼ºå¼•ç”¨
- å½“blockæ‹·è´åˆ°å †ä¸Šæ—¶ï¼Œéƒ½ä¼šé€šè¿‡copyå‡½æ•°æ¥å¤„ç†å®ƒä»¬
  - __blockå˜é‡ï¼ˆå‡è®¾å˜é‡åå«åšaï¼‰
  - Block_object_assign((void*)&dst->a, (void*)src->a, 8/*BLOCK_FIELD_IS_BYREF*/);
- å¯¹è±¡ç±»å‹çš„autoå˜é‡ï¼ˆå‡è®¾å˜é‡åå«åšpï¼‰
  - _Block_object_assign((void*)&dst->p, (void*)src->p, 3/*BLOCK_FIELD_IS_OBJECT*/)
- å½“blockä»å †ä¸Šç§»é™¤æ—¶ï¼Œéƒ½ä¼šé€šè¿‡disposeå‡½æ•°æ¥é‡Šæ”¾å®ƒä»¬
  - __blockå˜é‡ï¼ˆå‡è®¾å˜é‡åå«åšaï¼‰
    - Block_object_dispose((void*)src->a, 8/*BLOCK_FIELD_IS_BYREF*/);
  - å¯¹è±¡ç±»å‹çš„autoå˜é‡ï¼ˆå‡è®¾å˜é‡åå«åšpï¼‰
  - _Block_object_dispose((void*)src->p, 3/*BLOCK_FIELD_IS_OBJECT*/);



### è¢«__blockä¿®é¥°çš„å¯¹è±¡ç±»å‹

- å½“__blockå˜é‡åœ¨æ ˆä¸Šæ—¶ï¼Œä¸ä¼šå¯¹æŒ‡å‘çš„å¯¹è±¡äº§ç”Ÿå¼ºå¼•ç”¨
- å½“__blockå˜é‡è¢«copyåˆ°å †æ—¶
  - ä¼šè°ƒç”¨__blockå˜é‡å†…éƒ¨çš„copyå‡½æ•°
  - copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°
  - _Block_object_assignå‡½æ•°ä¼šæ ¹æ®æ‰€æŒ‡å‘å¯¹è±¡çš„ä¿®é¥°ç¬¦ï¼ˆ__strongã€__weakã€__unsafe_unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨ï¼ˆæ³¨æ„ï¼šè¿™é‡Œä»…é™äºARCæ—¶ä¼šretainï¼ŒMRCæ—¶ä¸ä¼šretainï¼‰

- å¦‚æœ__blockå˜é‡ä»å †ä¸Šç§»é™¤
  - ä¼šè°ƒç”¨__blockå˜é‡å†…éƒ¨çš„disposeå‡½æ•°
  - disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°
  - _Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾æŒ‡å‘çš„å¯¹è±¡ï¼ˆreleaseï¼‰



### å¾ªç¯å¼•ç”¨é—®é¢˜

#### è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ - ARC

- ç”¨__weakã€__unsafe_unretainedè§£å†³

  ![æˆªå±2020-07-08ä¸Šåˆ12.10.36](https://tva1.sinaimg.cn/large/007S8ZIlly1ggiv016t1hj30ka09uwh9.jpg)

- ç”¨__blockè§£å†³ï¼ˆå¿…é¡»è¦è°ƒç”¨blockï¼‰

  ![æˆªå±2020-07-08ä¸Šåˆ12.11.19](https://tva1.sinaimg.cn/large/007S8ZIlly1ggiv0qu8f5j31ao07idm4.jpg)



#### è§£å†³å¾ªç¯å¼•ç”¨é—®é¢˜ - MRC

- ç”¨__unsafe_unretainedè§£å†³

  ![æˆªå±2020-07-08ä¸Šåˆ12.12.01](https://tva1.sinaimg.cn/large/007S8ZIlly1ggiv1gjdbuj30k004ugmv.jpg)

- ç”¨__blockè§£å†³

  ![æˆªå±2020-07-08ä¸Šåˆ12.13.06](https://tva1.sinaimg.cn/large/007S8ZIlly1ggiv2lw0cjj30eo04mq3x.jpg)

